services:
  mc-bot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        # Use timestamp for cache busting on rebuilds
        - CACHEBUST=${CACHEBUST:-$(date +%s)}
      # Rebuild image if any file changes
      cache_from:
        - type=local,src=/tmp/.buildx-cache
    container_name: mc-bot
    restart: unless-stopped

    dns:
      - 8.8.8.8
      - 1.1.1.1

    # Port mappings
    ports:
      - "25565:25565" # Minecraft server
      - "25575:25575" # RCON

    # Volume mappings for persistent data
    volumes:
      - ./mc-server:/app/mc-server
      - ./backups:/app/backups
      - ./logs:/app/logs
      - ./.env:/app/.env
      # Don't persist cache
      - /app/src/__pycache__
      - /app/cogs/__pycache__

    # Environment variables from .env file
    env_file:
      - .env

    # Memory limit
    mem_limit: 8g

    # Keep container running
    tty: true
    stdin_open: true

    # Keep container running
    tty: true
    stdin_open: true
