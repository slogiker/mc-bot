services:
  mc-bot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        # Use timestamp for cache busting on rebuilds
        - CACHEBUST=${CACHEBUST:-$(date +%s)}
      # Rebuild image if any file changes
      cache_from:
        - type=local,src=/tmp/.buildx-cache
    container_name: mc-bot
    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "python -c 'import psutil; psutil.pid_exists(1)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

    dns:
      - 8.8.8.8
      - 1.1.1.1

    ports:
      - "25565:25565" # Minecraft server

    # Volume mappings for persistent data
    volumes:
      - ./mc-server:/app/mc-server
      - ./backups:/app/backups
      - ./logs:/app/logs
      - ./.env:/app/.env
      # Don't persist cache
      - /app/src/__pycache__
      - /app/cogs/__pycache__

    # Environment variables from .env file
    env_file:
      - .env

    # Memory limit
    mem_limit: 8g

    # Keep container running
    tty: true
    stdin_open: true

  playit:
    image: playitcloud/playit:0.15.19
    container_name: mc-bot-playit
    restart: unless-stopped
    environment:
      - SECRET_KEY=${PLAYIT_SECRET_KEY}
    network_mode: "service:mc-bot" # Share network namespace for localhost access if needed, OR explicit link
    depends_on:
      - mc-bot
