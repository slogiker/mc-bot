# Developer Documentation

**Repository**: `mc-bot`
**Version**: v2.5.3
**Last Updated**: February 2026

---

## üìñ Overview

This is a **self-hosted Discord bot** designed to manage a local Minecraft Java Edition server. It acts as a bridge between Discord and the server process, providing remote control, monitoring, and automation features.

### Core Philosophy
- **Private Use**: Built for small friend groups, not public servers.
- **Self-Contained**: No external web panels or databases required (uses JSON/Filelock).
- **Direct Control**: Wraps the server JAR process (`subprocess`) and uses RCON for commands.
- **Docker-First**: Recommended deployment via Docker Engine (Linux/WSL).

---

## üõ†Ô∏è Architecture Deep Dive

### Tech Stack
- **Python + discord.py**: rapid development of slash commands and asynchronous task management.
- **Subprocess**: The bot *is* the wrapper. It owns the Java process, capturing STDOUT directly for the log console.
- **Filelock**: Prevents race conditions when multiple async tasks read/write JSON config files.
- **Aiofiles**: Non-blocking log tailing keeps the Discord UI responsive while reading large server logs.

### File Structure (v2.5.3)

| Path | Description |
| :--- | :--- |
| **Root** | |
| `bot.py` | Main entry point. Loads cogs, starts ServerManager, handles shutdown signals. |
| `.env` | **Secret** configuration (Discord Token, RCON Password, API Keys). |
| `requirements.txt` | Python dependencies. |
| **Install (`install/`)** | |
| `install/install.bat` | **Windows Bootstrapper**. Installs WSL/Ubuntu, handles reboot, launches `install.sh`. |
| `install/install.sh` | **Linux Setup**. Installs Docker Engine, Python, Java. |
| `install/simulate.py` | **Ghost Mode**. Simulates installation and runs bot in RAM-only simulation mode. |
| **Cogs (`cogs/`)** | **Discord Command Modules** |
| `console.py` | Live log streaming, Owner-only RCON (`/cmd`), Presence updates. |
| `stats.py` | Player stats (`/stats`). Parses NBT `.dat` files for offline players and hits Mojang API for online. |
| `info.py` | System health (`/info`). Uses `psutil` to check CPU/RAM/Disk usage of the host. |
| `backup.py` | Backup commands (`/backup`). Triggers zip creation and ephemeral uploads. |
| `economy.py` | Balance system (`/pay`) and background "Word Hunt" minigame. |
| `ai.py` | AI integration. Uses `xai-sdk` to chat with Grok (`/ai`) and generate MOTDs. |
| `events.py` | Scheduling system (`/event`) with auto-reminders (24h/1h). |
| `automation.py` | Background tasks: AI MOTD updates and custom Regex Chat Triggers. |
| `management.py` | Control panel commands (Start/Stop/Restart). |
| `setup.py` | Setup wizard for completely new installations. |
| **Src (`src/`)** | **Core Logic & Helpers** |
| `backup_manager.py` | Handles Zipping world folders and interactions with `pyonesend`. |
| `server_info_manager.py` | Updates the persistent "Status" channel embed. |
| `logger.py` | Centralized logging configuration. |
| `utils.py` | RCON wrapper, file helpers, role checkers. |
| **Utils (`utils/`)** | |
| `config.py` | **Thread-safe** `load/save` for JSON configs using `FileLock`. |
| **Data (`data/`)** | **Persistent Storage** |
| `bot_config.json` | Core bot state: Economy balances, Event lists, Setup flags. |
| `user_config.json` | User preferences: Custom triggers, Schedule settings. |

---

## ‚öôÔ∏è Configuration Guide

### `bot_config.json` vs `user_config.json`
- **Bot Config**: Stores *system state* and *essential logic* (e.g., economy balances, scheduled events, server directory).
- **User Config**: Stores *user preferences* (e.g., keyword triggers, backup schedules).

### Environment Variables (.env)
- `BOT_TOKEN`: Required (Discord Bot Token).
- `RCON_PASSWORD`: Required (Auto-generated by installer).
- `XAI_API_KEY`: Optional (Enables Grok features).
- `ONE_SEND_TOKEN`: Optional (Auto-generated for backup uploads).

---

## üêã Docker Setup Details

The bot is designed to run in a Docker container for isolation and ease of management.

### Volumes
- `./mc-server`: Maps to `/app/mc-server` (Persistent Minecraft world/data).
- `./backups`: Maps to `/app/backups` (Persistent zip backups).
- `./logs`: Maps to `/app/logs` (Persistent bot logs).

### Ports
- **25565**: Minecraft Server (TCP/UDP).
- **25575**: RCON (TCP) - Local only by default.

### Memory
- Default limit: **8GB**. Adjust in `docker-compose.yml` (`mem_limit`).

---

## üëª Simulation / Ghost Mode

For testing or demonstration purposes, the bot can run in a **Simulation Mode** that mimics a full installation and server without modifying the host system.

### How to Run
```bash
python install/simulate.py
```

### What it does
1.  **Visual Mimicry**: Prints "fake" installation progress (WSL, Docker, etc.) identical to the real script.
2.  **Transient Token**: Prompts for a Discord Token securely. This token is **NEVER saved to disk**, only held in RAM.
3.  **Bot Simulation**: Launches `bot.py --simulate`.
    - Connects to Discord using the transient token.
    - Responds to commands (`/start`, `/stop`, etc.) with success messages.
    - **NO** files are created/modified (`.env`, `config.json`).
    - **NO** server/java process is started.

### Use Cases
- Testing Discord permissions/commands without a real server.
- Demonstrating the setup flow to users safely.
- Development of new commands without needing a heavy server running.

---

## üìú Version History & Changelog

### v2.5.3 (Current) - *The "Cleanup" Update*
- **Refactoring**:
  - Renamed `scripts/` to `install/`.
  - Consolidated installation logic into `install.bat` (Windows/WSL) and `install.sh` (Linux).
  - Added Ghost Mode simulation (`install/simulate.py`).
  - Deep cleaned root directory.
- **Documentation**:
  - Consolidated all technical docs into `DEVELOPER.md`.
  - Strict Emoji ban in terminal/logs.

### v2.5.2 - *Automation & Community*
- Added `cogs/events.py` for scheduling.
- Added `cogs/automation.py` for AI MOTD and Chat Triggers.
- Implemented Context-Aware Triggers (Log scanning).

### v2.5.0 - *Advanced Features*
- **Stats**: NBT Parsing (`nbtlib`) for offline player data.
- **Info**: `psutil` integration for real hardware monitoring.
- **Backups**: `pyonesend` integration for cloud zip sharing.
- **Economy**: Added "Word Hunt" and Balance system.

### v2.0.0 - *The Rewrite*
- Shifted to `discord.py` 2.0+ (Slash Commands).
- Introduced `cogs` architecture.
- Added `aiofiles` for non-blocking log tailing.

### v1.0.0 - *Legacy*
- Basic start/stop script.
- Single file monolith.
